version: '3.8'

services:
  deeplx:

    image: devinglaw/deeplxtov1api:latest
    container_name: deeplxtov1api
    restart: always
    
    # 关键：明确指定容器以 root 用户身份运行，赋予最高权限
    # 这将覆盖 Dockerfile 中的任何 USER 指令，保证权限
    user: root
    
    ports:
      - "38888:8000"

    # 从 .env 文件加载配置
    env_file:
      - ./app/.env

    # 环境变量，UVICORN_WORKERS 在这里定义，控制启动进程数
    environment:
      - UVICORN_WORKERS=2 
      - MAX_TEXT_LENGTH=5000
      - DEBUG=false
      - INITIAL_CHECK_DELAY=30

    volumes:
      # 挂载结果目录，root 用户可以无障碍写入
      - ./results:/app/results
      # 挂载日志目录，root 用户可以无障碍写入
      - ./logs:/app/logs
      # 同步宿主机时间
      - /etc/localtime:/etc/localtime:ro

    # 不再需要 tmpfs，直接挂载 logs 目录更直观
    # tmpfs:
    #   - /tmp:rw,noexec,nosuid,size=100m
      
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    
    networks:
      - deeplx-network

# 如果您使用 deploy 配置，可以保留
#   deploy:
#     resources:
#       limits:
#         cpus: '2'
#         memory: 1G
#       reservations:
#         cpus: '0.5'
#         memory: 256M

networks:
  deeplx-network:
    driver_opts:
      com.docker.network.driver.mtu: 1500